using System.Windows;
using MilkTeaShop.Domain.Entities;
using MilkTeaShop.Infrastructure.Services;
using MilkTeaShop.Application.Services; // Add this line for IMenuService

namespace MilkTeaShop.Presentation
{
    public partial class ManagerWorkWindow : Window
    {
        private readonly IUserService _userService;
        private readonly IMenuService _menuService;

        public ManagerWorkWindow()
        {
            try
            {
                Console.WriteLine("Starting ManagerWorkWindow initialization...");
                
                // Verify logged in user
                if (!CurrentUser.Instance.IsLoggedIn || CurrentUser.Instance.LoggedInUser == null)
                {
                    Console.WriteLine("ERROR: No logged-in user when ManagerWorkWindow constructor called");
                    MessageBox.Show("Lỗi khởi tạo: Không có thông tin đăng nhập!\n\nỨng dụng sẽ khởi động lại.", 
                                   "Lỗi đăng nhập", MessageBoxButton.OK, MessageBoxImage.Error);
                    RestartApplication();
                    return;
                }
                
                Console.WriteLine($"Logged in user confirmed: {CurrentUser.Instance.LoggedInUser.FullName} ({CurrentUser.Instance.LoggedInUser.Role})");
                
                // Initialize services
                _userService = new UserService();
                _menuService = new EfMenuService();
                
                // Initialize window
                InitializeComponent();
                Console.WriteLine("Window components initialized");
                
                // Force maximize window
                this.WindowState = WindowState.Maximized;
                Console.WriteLine("Window state set to Maximized");
                
                // Update UI for current user
                UpdateUIForCurrentUser();
                Console.WriteLine("UI updated for current user");
                
                // Load quick info
                LoadQuickInfo();
                
                Console.WriteLine("ManagerWorkWindow initialization completed successfully");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"CRITICAL ERROR in ManagerWorkWindow constructor: {ex.Message}");
                Console.WriteLine($"Stack trace: {ex.StackTrace}");
                
                MessageBox.Show($"Lỗi nghiêm trọng khi khởi tạo cửa sổ quản lý: {ex.Message}\n\n" +
                              $"Stack trace: {ex.StackTrace}\n\n" +
                              "Ứng dụng sẽ khởi động lại.", 
                              "Lỗi nghiêm trọng", MessageBoxButton.OK, MessageBoxImage.Error);
                
                RestartApplication();
            }
        }

        private void RestartApplication()
        {
            try
            {
                System.Windows.Application.Current.Shutdown();
                System.Diagnostics.Process.Start(System.Diagnostics.Process.GetCurrentProcess().MainModule!.FileName!);
            }
            catch
            {
                System.Windows.Application.Current.Shutdown();
            }
        }

        private void UpdateUIForCurrentUser()
        {
            if (!CurrentUser.Instance.IsLoggedIn) return;

            var user = CurrentUser.Instance.LoggedInUser!;
            
            // Update welcome text
            var welcomeText = this.FindName("WelcomeText") as System.Windows.Controls.TextBlock;
            var roleText = this.FindName("RoleText") as System.Windows.Controls.TextBlock;
            
            if (welcomeText != null)
                welcomeText.Text = $"Xin chào, {user.FullName}";
            
            if (roleText != null)
                roleText.Text = $"Vai trò: {CurrentUser.Instance.GetRoleDisplayName()}";
            
            Console.WriteLine($"Manager interface updated for: {user.FullName} ({user.Role})");
        }

        private async void LoadQuickInfo()
        {
            try
            {
                // Load employee count
                var users = await _userService.GetAllUsersAsync();
                var activeEmployees = users.Where(u => u.IsActive && u.Role == UserRole.Employee).Count();
                
                var employeeCountText = this.FindName("EmployeeCountText") as System.Windows.Controls.TextBlock;
                if (employeeCountText != null)
                    employeeCountText.Text = $"{activeEmployees} nhân viên";

                // Load menu items count
                var menuItems = await _menuService.GetAllItemsAsync();
                var menuItemsText = this.FindName("MenuItemsText") as System.Windows.Controls.TextBlock;
                if (menuItemsText != null)
                    menuItemsText.Text = $"{menuItems.Count()} sản phẩm";

                // Update system status
                var systemStatusText = this.FindName("SystemStatusText") as System.Windows.Controls.TextBlock;
                if (systemStatusText != null)
                    systemStatusText.Text = "Hoạt động bình thường";

                // Today's sales (placeholder)
                var todaySalesText = this.FindName("TodaySalesText") as System.Windows.Controls.TextBlock;
                if (todaySalesText != null)
                    todaySalesText.Text = "Chưa có dữ liệu";
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading quick info: {ex.Message}");
            }
        }

        private void ChangePassword_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var changePasswordWindow = new ChangePasswordWindow();
                changePasswordWindow.Owner = this;
                changePasswordWindow.ShowDialog();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi mở cửa sổ đổi mật khẩu: {ex.Message}", 
                               "Lỗi", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void Logout_Click(object sender, RoutedEventArgs e)
        {
            var result = MessageBox.Show(
                "Bạn có chắc muốn đăng xuất?", 
                "Xác nhận đăng xuất",
                MessageBoxButton.YesNo, 
                MessageBoxImage.Question);
                
            if (result == MessageBoxResult.Yes)
            {
                try
                {
                    Console.WriteLine("Manager logging out...");
                    CurrentUser.Instance.Logout();
                    
                    // Close current window and restart app with login
                    RestartApplication();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error during logout: {ex.Message}");
                    MessageBox.Show($"Lỗi đăng xuất: {ex.Message}", 
                                   "Lỗi", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        private void OpenPOS_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var posWindow = new MainWindow();
                posWindow.Show();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi mở hệ thống POS: {ex.Message}", "Lỗi", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void OpenReports_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var reportsWindow = new SalesReportWindow();
                reportsWindow.Owner = this;
                reportsWindow.ShowDialog();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi mở báo cáo: {ex.Message}", "Lỗi", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void OpenMenuManagement_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var settingsWindow = new SettingsWindow();
                settingsWindow.Owner = this;
                settingsWindow.ShowDialog();
                
                // Refresh info after menu management
                LoadQuickInfo();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi mở quản lý menu: {ex.Message}", "Lỗi", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void OpenUserManagement_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var userManagementWindow = new UserManagementWindow(canEditUsers: true);
                userManagementWindow.Owner = this;
                userManagementWindow.ShowDialog();
                
                // Refresh info after user management
                LoadQuickInfo();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi mở quản lý nhân viên: {ex.Message}", "Lỗi", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void OpenDatabaseManagement_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var databaseWindow = new DatabaseEditorWindow();
                databaseWindow.Owner = this;
                databaseWindow.ShowDialog();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi mở quản lý database: {ex.Message}", "Lỗi", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void OpenSettings_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var settingsWindow = new SettingsWindow();
                settingsWindow.Owner = this;
                settingsWindow.ShowDialog();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi mở cài đặt: {ex.Message}", "Lỗi", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void RefreshInfo_Click(object sender, RoutedEventArgs e)
        {
            LoadQuickInfo();
        }
    }
}